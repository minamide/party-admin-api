# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ«ãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ

## ðŸ“‹ ãƒ†ã‚¹ãƒˆæ¦‚è¦

[users.test.ts](./users.test.ts) ã«ã¯ã€Users API ãƒ«ãƒ¼ãƒˆã®çµ±åˆãƒ†ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

### ðŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|---|---|---|
| **GET /** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã€DBã‚¨ãƒ©ãƒ¼ | âœ… 2ä»¶ |
| **POST /** | æ­£å¸¸ä½œæˆã€å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¬ è½ã€ç„¡åŠ¹ãƒãƒ³ãƒ‰ãƒ«ã€ç„¡åŠ¹ãƒ¡ãƒ¼ãƒ« | âœ… 4ä»¶ |
| **GET /:id** | ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã€404ã‚¨ãƒ©ãƒ¼ã€DBã‚¨ãƒ©ãƒ¼ | âœ… 3ä»¶ |
| **PUT /:id** | æ›´æ–°æˆåŠŸã€ãƒ¡ãƒ¼ãƒ«ç„¡åŠ¹ã‚¨ãƒ©ãƒ¼ | âœ… 2ä»¶ |
| **DELETE /:id** | å‰Šé™¤æˆåŠŸã€å‰Šé™¤ã‚¨ãƒ©ãƒ¼ | âœ… 2ä»¶ |
| **åˆè¨ˆ** | - | âœ… **13ä»¶** |

---

## ðŸš€ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# ãƒ†ã‚¹ãƒˆä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -D vitest @vitest/ui happy-dom
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm test

# ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã«è‡ªå‹•å®Ÿè¡Œï¼‰
npm test -- --watch

# UI ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
npm run test:ui

# ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
npm run test:coverage
```

---

## ðŸ§ª ãƒ†ã‚¹ãƒˆã®è©³ç´°

### 1. **GET / - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—**

#### âœ… æ­£å¸¸ç³»
- **ãƒ†ã‚¹ãƒˆ**: `should return list of users with 200 status`
- **æœŸå¾…å€¤**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 200ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼é…åˆ—ã‚’è¿”ã™
- **ãƒ¢ãƒƒã‚¯**: DB ã® `select().from(users).all()` ãŒè¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿”ã™

#### âŒ ã‚¨ãƒ©ãƒ¼ç³»
- **ãƒ†ã‚¹ãƒˆ**: `should return 500 on database error`
- **æœŸå¾…å€¤**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 500ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ `USERS_LIST_ERROR`
- **ãƒ¢ãƒƒã‚¯**: DB ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹

---

### 2. **POST / - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ**

#### âœ… æ­£å¸¸ç³»
- **ãƒ†ã‚¹ãƒˆ**: `should create user with valid data and return 201`
- **æœŸå¾…å€¤**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 201ã€ä½œæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
- **å…¥åŠ›ä¾‹**:
  ```json
  {
    "id": "user-123",
    "name": "Charlie",
    "handle": "charlie",
    "email": "charlie@test.com",
    "role": "user"
  }
  ```

#### âŒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼

**a) å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¬ è½**
- **ãƒ†ã‚¹ãƒˆ**: `should return 400 for missing required fields`
- **æœŸå¾…å€¤**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 400ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ `VALIDATION_ERROR`ã€æ¬ è½ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆä»˜ã
- **ã‚·ãƒŠãƒªã‚ª**: `name` ã¨ `handle` ã‚’çœç•¥

**b) ç„¡åŠ¹ãƒãƒ³ãƒ‰ãƒ«å½¢å¼**
- **ãƒ†ã‚¹ãƒˆ**: `should return 400 for invalid handle format`
- **æœŸå¾…å€¤**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 400ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ `INVALID_HANDLE`
- **ãƒ«ãƒ¼ãƒ«**: 3-30æ–‡å­—ã€è‹±æ•°å­—ã¨ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿

**c) ç„¡åŠ¹ãƒ¡ãƒ¼ãƒ«å½¢å¼**
- **ãƒ†ã‚¹ãƒˆ**: `should return 400 for invalid email format`
- **æœŸå¾…å€¤**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 400ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ `INVALID_EMAIL`
- **ãƒ«ãƒ¼ãƒ«**: æ¨™æº–ãƒ¡ãƒ¼ãƒ«å½¢å¼ï¼ˆ`user@domain.com`ï¼‰

---

### 3. **GET /:id - ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—**

#### âœ… æ­£å¸¸ç³»
- **ãƒ†ã‚¹ãƒˆ**: `should return user by id with 200 status`
- **æœŸå¾…å€¤**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 200ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
- **URLä¾‹**: `/user-123`

#### âŒ ã‚¨ãƒ©ãƒ¼ç³»

**a) ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã— (404)**
- **ãƒ†ã‚¹ãƒˆ**: `should return 404 when user not found`
- **æœŸå¾…å€¤**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 404ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ `USER_NOT_FOUND`

**b) DB ã‚¨ãƒ©ãƒ¼**
- **ãƒ†ã‚¹ãƒˆ**: `should return 500 on database error`
- **æœŸå¾…å€¤**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 500ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ `USER_GET_ERROR`

---

### 4. **PUT /:id - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°**

#### âœ… æ­£å¸¸ç³»
- **ãƒ†ã‚¹ãƒˆ**: `should update user and return 200`
- **æœŸå¾…å€¤**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 200ã€æ›´æ–°ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
- **æ›´æ–°å¯èƒ½ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**: `name`, `email`, `bio`, `photoUrl`, `bannerUrl`

#### âŒ ã‚¨ãƒ©ãƒ¼ç³»
- **ãƒ†ã‚¹ãƒˆ**: `should return 400 for invalid email during update`
- **æœŸå¾…å€¤**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 400ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ `INVALID_EMAIL`

---

### 5. **DELETE /:id - ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤**

#### âœ… æ­£å¸¸ç³»
- **ãƒ†ã‚¹ãƒˆ**: `should delete user and return 200 with success`
- **æœŸå¾…å€¤**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 200ã€`{ success: true }`ã‚’è¿”ã™

#### âŒ ã‚¨ãƒ©ãƒ¼ç³»
- **ãƒ†ã‚¹ãƒˆ**: `should return 400 on database error during delete`
- **æœŸå¾…å€¤**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 400ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ `USER_DELETE_ERROR`

---

## ðŸ”§ ãƒ¢ãƒƒã‚¯æˆ¦ç•¥

ãƒ†ã‚¹ãƒˆã§ã¯ä»¥ä¸‹ã‚’ vi.mock() ã§ãƒ¢ãƒƒã‚¯åŒ–ï¼š

```typescript
// DB ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
getDb()

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
getErrorMessage()
createErrorResponse()

// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
validateRequired()
isValidEmail()
isValidHandle()
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- DB ã¸ã®å®Ÿéš›ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒãªã„ï¼ˆé«˜é€Ÿï¼‰
- å¤–éƒ¨ä¾å­˜ãŒãªã„ï¼ˆåˆ†é›¢ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆï¼‰
- äºˆæ¸¬å¯èƒ½ãªå‹•ä½œ

---

## ðŸ“ˆ æ‹¡å¼µäºˆå®š

ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ äºˆå®š:

- [ ] ä»–ã®ãƒ«ãƒ¼ãƒˆï¼ˆposts, communities ãªã©ï¼‰ã®çµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆå®Ÿéš›ã® D1 ã‚’ä½¿ç”¨ï¼‰
- [ ] E2E ãƒ†ã‚¹ãƒˆï¼ˆMiniflare ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œï¼‰
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] è² è·ãƒ†ã‚¹ãƒˆ

---

## ðŸ’¡ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **ãƒ†ã‚¹ãƒˆåã¯æ˜Žç¢ºã«**: `should return 200 when ...` ã¨ã„ã†å½¢å¼
2. **1ãƒ†ã‚¹ãƒˆ1ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³**: è¤‡æ•°ã®æ¤œè¨¼ã¯åˆ†å‰²
3. **ãƒ¢ãƒƒã‚¯åŒ–**: å¤–éƒ¨ä¾å­˜ã¯å¿…ãšãƒ¢ãƒƒã‚¯
4. **ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: `beforeEach` ã§çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
5. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: ãƒ†ã‚¹ãƒˆã§ API ã®ä»•æ§˜ã‚’èª¬æ˜Ž

---

## ðŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œãªã„
```bash
npm install -D vitest happy-dom
npm test
```

### ãƒ¢ãƒƒã‚¯è¨­å®šã‚¨ãƒ©ãƒ¼
- `vitest.config.ts` ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ãŒæ­£ç¢ºã‹ç¢ºèª

### éžåŒæœŸãƒ†ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
```typescript
it('test name', async () => { ... }, 10000); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ 10ç§’
```
